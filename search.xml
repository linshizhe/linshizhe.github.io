<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[CentOS 6.5下PXE+Kickstart无人值守安装操作系统]]></title>
    <url>%2F2017%2F07%2F15%2FPXE%2BKickstart%2F</url>
    <content type="text"><![CDATA[一、前言1.1什么是PXEPXE(Pre-boot Execution Environment，预启动执行环境)是由Intel公司开发的最新技术，工作于Client/Server的网络模式，支持工作站通过网络从远端服务器下载映像，并由此支持通过网络启动操作系统，在启动过程中，终端要求服务器分配IP地址，再用TFTP（trivial file transfer protocol）或MTFTP(multicast trivial file transfer protocol)协议下载一个启动软件包到本机内存中执行，由这个启动软件包完成终端基本软件设置，从而引导预先安装在服务器中的终端操作系统。严格来说，PXE 并不是一种安装方式，而是一种引导方式。进行 PXE 安装的必要条件是在要安装的计算机中必须包含一个 PXE 支持的网卡（NIC），即网卡中必须要有 PXE Client。PXE 协议可以使计算机通过网络启动。此协议分为 Client端和 Server 端，而PXE Client则在网卡的 ROM 中。当计算机引导时，BIOS 把 PXE Client 调入内存中执行，然后由 PXE Client 将放置在远端的文件通过网络下载到本地运行。运行 PXE 协议需要设置 DHCP 服务器和 TFTP 服务器。DHCP 服务器会给 PXE Client（将要安装系统的主机）分配一个 IP 地址，由于是给 PXE Client 分配 IP 地址，所以在配置 DHCP 服务器时需要增加相应的 PXE 设置。此外，在 PXE Client 的 ROM 中，已经存在了 TFTP Client，那么它就可以通过 TFTP 协议到 TFTP Server 上下载所需的文件了。 pxe的工作过程： PXE Client 从自己的PXE网卡启动，向本网络中的DHCP服务器索取IP； DHCP 服务器返回分配给客户机的IP 以及PXE文件的放置位置(该文件一般是放在一台TFTP服务器上) ； PXE Client 向本网络中的TFTP服务器索取pxelinux.0 文件； PXE Client 取得pxelinux.0 文件后之执行该文件； 根据pxelinux.0 的执行结果，通过TFTP服务器加载内核和文件系统 ； 进入安装画面, 此时可以通过选择HTTP、FTP、NFS 方式之一进行安装；详细工作流程，请参考下面这幅图： 1.2初认KickstartKickstart是一种无人值守的安装方式。它的工作原理是在安装过程中记录典型的需要人工干预填写的各种参数，并生成一个名为ks.cfg的文件。如果在安装过程中（不只局限于生成Kickstart安装文件的机器）出现要填写参数的情况，安装程序首先会去查找Kickstart生成的文件，如果找到合适的参数，就采用所找到的参数；如果没有找到合适的参数，便需要安装者手工干预了。所以，如果Kickstart文件涵盖了安装过程中可能出现的所有需要填写的参数，那么安装者完全可以只告诉安装程序从何处取ks.cfg文件，然后就去忙自己的事情。等安装完毕，安装程序会根据ks.cfg中的设置重启系统，并结束安装。 PXE+Kickstart 无人值守安装操作系统完整过程如下： 二、系统环境实验环境：VMware Workstation 11 系统平台：CentOS release 6.5 (最小化安装) 网络模式：NAT模式（共享主机的IP地址） DHCP / TFTP IP：192.168.198.3 HTTP / FTP / NFS IP：192.168.198.3 防火墙状态：关闭 #service iptables stop #chkconfig iptables off #service iptables status SELINUX=disabled #vi /etc/sysconfig/selinux 三、准备工作生成ks.cfg 文件需要system-config-kickstart 工具，而此工具依赖于X Windows，所以我们需要安装X Windows 和Desktop 并重启系统，操作如下： #yum groupinstall &quot;X Window System&quot; #yum groupinstall Desktop #reboot 四、配置HTTP安装方式系统的安装方式可以选择HTTP、FTP、 NFS，这里介绍HTTP方式的安装 1）安装http #yum install httpd –y #rpm -qa|grep httpd 2) 开启服务并设置开机启动 #/etc/init.d/httpd start #chkconfig --level 35 httpd on 3)在虚拟机中设置加载ISO镜像 4)将iso文件挂载至/mnt/cdrom #mkdir /mnt/cdrom #mount /dev/cdrom /mnt/cdrom 5)复制光盘全部内容至http 的根目录/var/www/html/ 下 #cp -r /mnt/cdrom/ /var/www/html/ HTTP部分设置完成。 五、配置TFTP1）安装tftp-server #yum install tftp-server –y #grep -qa|grep tftp-server 2)启用tftp服务 #vi /etc/xinetd.d/tftp 3）修改配置文件如下，将disable设置成no service tftp { socket_type = dgram protocol = udp wait = yes user = root server = /usr/sbin/in.tftpd server_args = -s /var/lib/tftpboot disable = no per_source = 11 cps = 100 2 flags = IPv4 } 4）启动tftp服务，因为tftp服务是挂载在超级进程xinetd 下的，所以通过启动xinetd 来启动tftp服务。 #/etc/init.d/xinetd restart 设置开机启动xinetd #chkconfig xinetd on 六、配置支持PXE的启动程序1）复制pxelinux.0 文件至/var/lib/tftpboot/ 文件夹中，（需要先用yum方式安装syslinux） #yum –y install syslinux #cp /usr/share/syslinux/pxelinux.0 /var/lib/tftpboot/ 说明：syslinux是一个功能强大的引导加载程序，而且兼容各种介质。更加确切地说：SYSLINUX是一个小型的Linux操作系统，它的目的是简化首次安装Linux的时间，并建立修护或其它特殊用途的启动盘。 2)复制iso镜像中的 /image/pxeboot/initrd.img 和 vmlinux到 /var/lib/tftpboot/ 目录中 #cp /var/www/html/cdrom/images/pxeboot/{initrd.img,vmlinuz} /var/lib/tftpboot/ 3）复制iso镜像中的 /isolinux/*.msg 到 /var/lib/tftpboot/ 目录中 #cp /var/www/html/cdrom/isolinux/*.msg /var/lib/tftpboot/ 4）在/var/lib/tftpboot/ 中新建一个pxelinux.cfg目录 #mkdir /var/lib/tftpboot/pxelinux.cfg 5）将iso 镜像中的/isolinux 目录中的isolinux.cfg复制到pxelinux.cfg目录中，同时更改文件名称为default #cp /var/www/html/cdrom/isolinux/isolinux.cfg /var/lib/tftpboot/pxelinux.cfg/default 6）修改default文件 #vi /var/lib/tftpboot/pxelinux.cfg/default 配置如下： default ks #默认启动的是 &apos;label ks&apos; 中标记的启动内核 prompt 1 #显示 &apos;boot: &apos; 提示符。为 &apos;0&apos; 时则不提示，将会直接启动 &apos;default&apos; 参数中指定的内容。 timeout 6 #在用户输入之前的超时时间，单位为 1/10 秒。 display boot.msg #显示某个文件的内容，注意文件的路径。默认是在/var/lib/tftpboot/ 目录下。也可以指定位类似 &apos;/install/boot.msg&apos;这样的，路径+文件名。 F1 boot.msg #按下 &apos;F1&apos; 这样的键后显示的文件。 F2 options.msg F3 general.msg F4 param.msg F5 rescue.msg label linux #&apos;label&apos; 指定你在 &apos;boot:&apos; 提示符下输入的关键字，比如boot: linux[ENTER]，这个会启动&apos;label linux&apos; 下标记的kernel 和initrd.img 文件。 kernel vmlinuz #kernel 参数指定要启动的内核。 append initrd=initrd.img #append 指定追加给内核的参数，能够在grub 里使用的追加给内核的参数，在这里也都可以使用。 label text kernel vmlinuz append initrd=initrd.img text label ks kernel vmlinuz append ks=http://192.168.198.3/ks.cfg initrd=initrd.img #告诉系统，从哪里获取ks.cfg文件 label local localboot 1 label memtest86 kernel memtest append - 七、配置DHCP1)安装DHCP服务 #yum -y install dhcp 2）复制配置模板文件到DHCP的配置目录中 #cp -f /usr/share/doc/dhcp-4.1.1/dhcpd.conf.sample /etc/dhcp/dhcpd.conf 3）修改DHCP配置文件 #vi /etc/dhcp/dhcpd.conf 配置如下： ddns-update-style interim; ignore client-updates; filename &quot;pxelinux.0&quot;; next-server 192.168.198.3; subnet 192.168.198.0 netmask 255.255.255.0 { range dynamic-bootp 192.168.198.10 192.168.198.200; option subnet-mask 255.255.255.0; option routers 192.168.198.3; option broadcast-address 192.168.198.254; default-lease-time 21600; max-lease-time 43200; } 4）启动DHCP服务 #/etc/init.d/dhcpd start 八、生成ks.cfg 文件1）安装Kickstart #yum -y install system-config-kickstart 2）在桌面环境下配置Kickstart，启动X Windows 环境，并配置Kickstart #startx #system-config-kickstart 3）注意事项：system-config-kickstart 启动报错如下 解决方法： #yum -y install glib2-devel 4）设置kickstart参数 设置语言，键盘，时区，Root密码，安装完毕后重启等。 设置安装方式，这篇文章介绍的是HTTP方式的安装，故选择HTTP 设置安装安装MBR 设置磁盘分区 分区规划：这里先测试三个主分区 分区总览 配置网络 认证配置 SELinux 和防火墙配置 图形环境配置 软件包安装选择 预览 生成ks.cfg 文件，保存在/var/www/html/ 文件夹下 打开/var/www/html/ks.cfg 文件进行查看并做修改。 #vi /var/www/html/ks.cfg 配置如下： platform=x86, AMD64, or Intel EM64T #version=DEVEL # Firewall configuration firewall --disabled # Install OS instead of upgrade install # Use network installation url --url=http://192.168.198.3/cdrom/ #这个选项告诉安装程序：到服务器192.168.198.3 的HTTP根目录下的cdrom 文件夹下寻找安装介质 # Root password rootpw --iscrypted $1$vsvtP./e$6PVMNfJd.shq2LgFJjYfA1 # System authorization information auth --useshadow --enablemd5 # Use graphical install graphical firstboot --disable # System keyboard keyboard us # System language lang en_US # SELinux configuration selinux --disabled # Installation logging level logging --level=info # Reboot after installation reboot # System timezone timezone --isUtc Asia/Shanghai # Network information network --bootproto=dhcp --device=eth0 --onboot=on # System bootloader configuration key --skip bootloader --append=&quot;rhgb quiet&quot; --location=mbr --driveorder=sda # Clear the Master Boot Record zerombr # Partition clearing information clearpart --all --initlabel # Disk partitioning information part / --fstype=&quot;ext4&quot; --size=8192 part swap --fstype=&quot;swap&quot; --size=1024 part /home --fstype=&quot;ext4&quot; --size=2048 %packages @base %end 注意事项：key –skip 如果是红帽系统，此选项可以跳过输入序列号过程；如果是CentOS 系列，则可以不保留此项内容；reboot 此选项必须存在，也必须文中设定位置，不然kickstart显示一条消息，并等待用户按任意键后才重新引导；clearpart –all –initlabel 此条命令必须添加，不然系统会让用户手动选择是否清除所有数据，这就需要人为干预了，从而导致自动化过程失败； 九、测试安装1）新建个虚拟机，添加一块500G硬盘，内存1024M够测试用就可以。 2）点击开机按钮，启动虚拟机后，快速按下F12键进入pxe环境 启动虚拟机，选择从网卡启动，DHCP 服务器正在给客户机分配IP地址。 开始下载vmlinuz 和initrd.img 3) 成功安装系统到login界面后，按前面设置的root密码进去查看，分区是否和我们设置的一样 PXE+Kickstart 无人值守安装操作系统环境搭建完毕。]]></content>
      <categories>
        <category>运维</category>
      </categories>
      <tags>
        <tag>Kickstart</tag>
        <tag>PXE</tag>
      </tags>
  </entry>
</search>